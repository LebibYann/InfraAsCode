name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - dev
          - prd
      confirm:
        description: 'Type "destroy" to confirm'
        required: true
        type: string

permissions:
  id-token: write   # For OIDC
  contents: read

jobs:
  validate-confirmation:
    name: Validate Destruction Request
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "destroy" ]; then
            echo "âŒ Confirmation failed. You must type 'destroy' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Production safety check
        if: github.event.inputs.environment == 'prd'
        run: |
          echo "âš ï¸  WARNING: Production environment destruction requested!"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"

  terraform-destroy:
    name: Destroy ${{ github.event.inputs.environment }} Infrastructure
    needs: validate-confirmation
    runs-on: [self-hosted, kubernetes, gke, linux, x64]
    environment:
      name: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0
          terraform_wrapper: false

      - name: Authenticate to Google Cloud (Dev)
        if: github.event.inputs.environment == 'dev'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/659049800117/locations/global/workloadIdentityPools/github-pool-ci/providers/github-provider-ci
          service_account: terraform-ci-dev@infra-as-code-tek.iam.gserviceaccount.com

      - name: Authenticate to Google Cloud (Prd)
        if: github.event.inputs.environment == 'prd'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: to_set
          service_account: to_set

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ github.event.inputs.environment == 'dev' && 'infra-as-code-tek' || 'lenny-iac-prd' }}

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials iac-cluster \
            --region=europe-west1 \
            --project=${{ github.event.inputs.environment == 'dev' && 'infra-as-code-tek' || 'lenny-iac-prd' }} || echo "Cluster not found or already destroyed"

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="environments/${{ github.event.inputs.environment }}/backend.tfvars" \
            -reconfigure

      - name: Terraform Refresh
        working-directory: ./terraform
        run: |
          terraform refresh \
            -var-file="environments/${{ github.event.inputs.environment }}/terraform.tfvars"

      - name: Terraform Plan Destroy
        working-directory: ./terraform
        run: |
          terraform plan -destroy \
            -var-file="environments/${{ github.event.inputs.environment }}/terraform.tfvars" \
            -out="environments/${{ github.event.inputs.environment }}/destroy.tfplan"

      - name: Final Confirmation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  FINAL WARNING âš ï¸"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Action: DESTROY ALL INFRASTRUCTURE"
          echo "Triggered by: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sleep 5

      - name: Terraform Destroy
        working-directory: ./terraform
        run: |
          terraform apply "environments/${{ github.event.inputs.environment }}/destroy.tfplan"

      - name: Cleanup Plan Files
        if: always()
        working-directory: ./terraform
        run: |
          rm -f environments/${{ github.event.inputs.environment }}/output.tfplan
          rm -f environments/${{ github.event.inputs.environment }}/destroy.tfplan

      - name: Verify Destruction
        if: success()
        run: |
          echo "âœ… Infrastructure destroyed successfully"
          echo ""
          echo "ğŸ“‹ Post-destruction checklist:"
          echo "  1. Verify no orphaned resources in GCP Console"
          echo "  2. Check for lingering disks and IP addresses"
          echo "  3. Review firewall rules"
          echo "  4. Confirm storage buckets are removed"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Destruction failed!"
          echo ""
          echo "Some resources may still exist. Please:"
          echo "  1. Check the error messages above"
          echo "  2. Manually remove protected resources via GCP Console"
          echo "  3. Re-run this workflow if needed"
